Performance optimizations of derived table trimming and pruning, should fix the
issues some nodes encounter with these database operations taking too long.

Other minor bugfixes.

